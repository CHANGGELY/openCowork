"""
============================================
Agent å¾ªç¯æ ¸å¿ƒæ¨¡å—
============================================
è¿™ä¸ªæ–‡ä»¶æ˜¯ openCowork çš„"å¤§è„‘"ã€‚

å®ƒå®ç°äº†ä¸€ä¸ªæ— é™å¾ªç¯ï¼š
1. æˆªå›¾ â†’ 2. å‘ç»™ LLM â†’ 3. LLM è¿”å›æ“ä½œæŒ‡ä»¤ â†’ 4. æ‰§è¡Œæ“ä½œ â†’ å›åˆ° 1

è¿™ä¸ªå¾ªç¯ä¼šä¸€ç›´è¿è¡Œï¼Œç›´åˆ°ï¼š
- LLM è¯´"ä»»åŠ¡å®Œæˆäº†"
- ç”¨æˆ·æŒ‰ä¸‹åœæ­¢å¿«æ·é”®ï¼ˆCtrl+Alt+Qï¼‰
- å‘ç”Ÿé”™è¯¯

ç±»æ¯”ï¼šå°±åƒä¸€ä¸ªä¸æ–­"è§‚å¯Ÿ â†’ æ€è€ƒ â†’ è¡ŒåŠ¨"çš„æœºå™¨äººã€‚
"""

import asyncio
import base64
import threading
from typing import Callable, Optional

from loguru import logger
from pynput import keyboard

from providers.base import LLMæä¾›è€…åŸºç±», å·¥å…·è°ƒç”¨
from tools.screen import æˆªå–å±å¹•
from tools.computer import æ‰§è¡Œé¼ æ ‡æ“ä½œ, æ‰§è¡Œé”®ç›˜æ“ä½œ

# ============================================
# å…¨å±€åœæ­¢ä¿¡å·ï¼ˆç”¨äºç´§æ€¥åœæ­¢ï¼‰
# ============================================

å…¨å±€åœæ­¢ä¿¡å· = threading.Event()

def è®¾ç½®å…¨å±€çƒ­é”®():
    """
    è®¾ç½®å…¨å±€å¿«æ·é”® Ctrl+Alt+Q æ¥åœæ­¢ Agentã€‚
    è¿™ä¸ªçƒ­é”®åœ¨ä»»ä½•æ—¶å€™éƒ½èƒ½ç”Ÿæ•ˆï¼Œå³ä½¿ç„¦ç‚¹ä¸åœ¨æˆ‘ä»¬çš„åº”ç”¨ä¸Šã€‚
    """
    å½“å‰æŒ‰ä¸‹çš„é”® = set()
    
    def æŒ‰ä¸‹(key):
        å½“å‰æŒ‰ä¸‹çš„é”®.add(key)
        # æ£€æŸ¥æ˜¯å¦åŒæ—¶æŒ‰ä¸‹äº† Ctrl + Alt + Q
        if (
            keyboard.Key.ctrl_l in å½“å‰æŒ‰ä¸‹çš„é”® or keyboard.Key.ctrl_r in å½“å‰æŒ‰ä¸‹çš„é”®
        ) and (
            keyboard.Key.alt_l in å½“å‰æŒ‰ä¸‹çš„é”® or keyboard.Key.alt_r in å½“å‰æŒ‰ä¸‹çš„é”®
        ):
            try:
                if keyboard.KeyCode.from_char('q') in å½“å‰æŒ‰ä¸‹çš„é”®:
                    logger.warning("ğŸ›‘ æ£€æµ‹åˆ° Ctrl+Alt+Qï¼Œæ­£åœ¨åœæ­¢ Agent...")
                    å…¨å±€åœæ­¢ä¿¡å·.set()
            except Exception:
                pass
    
    def æ¾å¼€(key):
        å½“å‰æŒ‰ä¸‹çš„é”®.discard(key)
    
    # åœ¨åå°çº¿ç¨‹ä¸­ç›‘å¬é”®ç›˜
    listener = keyboard.Listener(on_press=æŒ‰ä¸‹, on_release=æ¾å¼€)
    listener.daemon = True
    listener.start()
    logger.info("âŒ¨ï¸ å…¨å±€å¿«æ·é”®å·²å¯ç”¨: Ctrl+Alt+Q åœæ­¢ Agent")


# å¯åŠ¨æ—¶è‡ªåŠ¨è®¾ç½®çƒ­é”®
è®¾ç½®å…¨å±€çƒ­é”®()


# ============================================
# Agent å¾ªç¯ç±»
# ============================================

class AgentLoop:
    """
    Agent ä¸»å¾ªç¯ç±»
    
    åŠŸèƒ½ï¼š
    1. ç®¡ç†ä¸ LLM çš„å¯¹è¯
    2. æ‰§è¡Œ LLM è¿”å›çš„å·¥å…·è°ƒç”¨ï¼ˆé¼ æ ‡ã€é”®ç›˜æ“ä½œï¼‰
    3. æŒç»­å¾ªç¯ç›´åˆ°ä»»åŠ¡å®Œæˆ
    """
    
    def __init__(
        self,
        æä¾›è€…: LLMæä¾›è€…åŸºç±»,
        å¹¿æ’­å‡½æ•°: Optional[Callable] = None,
        æœ€å¤§å¾ªç¯æ¬¡æ•°: int = 50
    ):
        """
        åˆå§‹åŒ– Agent å¾ªç¯
        
        å‚æ•°:
            æä¾›è€…: LLM æä¾›è€…å®ä¾‹ï¼ˆOpenAI/Gemini/Anthropicï¼‰
            å¹¿æ’­å‡½æ•°: ç”¨äºå‘å‰ç«¯æ¨é€æ—¥å¿—çš„å‡½æ•°
            æœ€å¤§å¾ªç¯æ¬¡æ•°: é˜²æ­¢æ— é™å¾ªç¯çš„ä¿æŠ¤æªæ–½
        """
        self.æä¾›è€… = æä¾›è€…
        self.å¹¿æ’­ = å¹¿æ’­å‡½æ•° or (lambda msg, typ: None)
        self.æœ€å¤§å¾ªç¯æ¬¡æ•° = æœ€å¤§å¾ªç¯æ¬¡æ•°
        
        self.æ­£åœ¨è¿è¡Œ = False
        self.å½“å‰ä»»åŠ¡: Optional[str] = None
        self.å¯¹è¯å†å²: list = []
    
    async def æ‰§è¡Œä»»åŠ¡(self, ç”¨æˆ·æŒ‡ä»¤: str):
        """
        æ‰§è¡Œç”¨æˆ·æŒ‡å®šçš„ä»»åŠ¡
        
        è¿™æ˜¯æ•´ä¸ª Agent çš„æ ¸å¿ƒå¾ªç¯ï¼š
        æˆªå›¾ â†’ å‘ç»™ LLM â†’ æ‰§è¡Œæ“ä½œ â†’ é‡å¤
        """
        self.æ­£åœ¨è¿è¡Œ = True
        self.å½“å‰ä»»åŠ¡ = ç”¨æˆ·æŒ‡ä»¤
        å…¨å±€åœæ­¢ä¿¡å·.clear()  # é‡ç½®åœæ­¢ä¿¡å·
        
        await self._å¹¿æ’­("info", f"ğŸ“‹ æ”¶åˆ°ä»»åŠ¡: {ç”¨æˆ·æŒ‡ä»¤}")
        logger.info(f"å¼€å§‹æ‰§è¡Œä»»åŠ¡: {ç”¨æˆ·æŒ‡ä»¤}")
        
        # åˆå§‹åŒ–å¯¹è¯ï¼ˆåŠ å…¥ç”¨æˆ·æŒ‡ä»¤ï¼‰
        self.å¯¹è¯å†å² = [{"role": "user", "content": ç”¨æˆ·æŒ‡ä»¤}]
        
        å¾ªç¯æ¬¡æ•° = 0
        try:
            while å¾ªç¯æ¬¡æ•° < self.æœ€å¤§å¾ªç¯æ¬¡æ•°:
                # æ£€æŸ¥åœæ­¢ä¿¡å·
                if å…¨å±€åœæ­¢ä¿¡å·.is_set():
                    await self._å¹¿æ’­("info", "ğŸ›‘ ä»»åŠ¡å·²åœæ­¢")
                    break
                
                å¾ªç¯æ¬¡æ•° += 1
                await self._å¹¿æ’­("info", f"ğŸ”„ å¾ªç¯ {å¾ªç¯æ¬¡æ•°}/{self.æœ€å¤§å¾ªç¯æ¬¡æ•°}")
                
                # Step 1: æˆªå›¾
                await self._å¹¿æ’­("action", "ğŸ“¸ æ­£åœ¨æˆªå›¾...")
                æˆªå›¾æ•°æ® = await self._è·å–æˆªå›¾()
                if not æˆªå›¾æ•°æ®:
                    await self._å¹¿æ’­("error", "âŒ æˆªå›¾å¤±è´¥")
                    break
                
                # Step 2: å‘é€ç»™ LLM
                await self._å¹¿æ’­("action", "ğŸ¤” æ­£åœ¨æ€è€ƒ...")
                å“åº” = await self._è°ƒç”¨LLM(æˆªå›¾æ•°æ®)
                
                if not å“åº”:
                    await self._å¹¿æ’­("error", "âŒ LLM è°ƒç”¨å¤±è´¥")
                    break
                
                # Step 3: å¤„ç† LLM å“åº”
                if å“åº”.æ–‡æœ¬å†…å®¹:
                    await self._å¹¿æ’­("info", f"ğŸ’¬ AI: {å“åº”.æ–‡æœ¬å†…å®¹}")
                
                # æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
                if not å“åº”.å·¥å…·è°ƒç”¨åˆ—è¡¨:
                    # æ²¡æœ‰å·¥å…·è°ƒç”¨ï¼Œè¯´æ˜ä»»åŠ¡å¯èƒ½å®Œæˆäº†
                    await self._å¹¿æ’­("info", "âœ… ä»»åŠ¡å®Œæˆï¼ˆæ— æ›´å¤šæ“ä½œï¼‰")
                    break
                
                # Step 4: æ‰§è¡Œå·¥å…·è°ƒç”¨
                for å·¥å…·è°ƒç”¨ in å“åº”.å·¥å…·è°ƒç”¨åˆ—è¡¨:
                    if å…¨å±€åœæ­¢ä¿¡å·.is_set():
                        break
                    
                    ç»“æœ = await self._æ‰§è¡Œå·¥å…·(å·¥å…·è°ƒç”¨)
                    await self._å¹¿æ’­("action", f"ğŸ”§ æ‰§è¡Œ: {å·¥å…·è°ƒç”¨.å·¥å…·åç§°} â†’ {ç»“æœ}")
                
                # ç»™ç³»ç»Ÿä¸€ç‚¹å–˜æ¯æ—¶é—´
                await asyncio.sleep(0.5)
            
            if å¾ªç¯æ¬¡æ•° >= self.æœ€å¤§å¾ªç¯æ¬¡æ•°:
                await self._å¹¿æ’­("warning", f"âš ï¸ è¾¾åˆ°æœ€å¤§å¾ªç¯æ¬¡æ•° ({self.æœ€å¤§å¾ªç¯æ¬¡æ•°})")
        
        except Exception as e:
            await self._å¹¿æ’­("error", f"âŒ å‘ç”Ÿé”™è¯¯: {str(e)}")
            logger.exception("Agent æ‰§è¡Œå‡ºé”™")
        
        finally:
            self.æ­£åœ¨è¿è¡Œ = False
            self.å½“å‰ä»»åŠ¡ = None
            # å‘é€çŠ¶æ€æ›´æ–°ï¼Œå‘Šè¯‰å‰ç«¯å·²åœæ­¢
            await self._å¹¿æ’­("status", {"is_running": False})
            logger.info("ä»»åŠ¡æ‰§è¡Œç»“æŸ")
    
    async def _è·å–æˆªå›¾(self) -> Optional[str]:
        """
        æˆªå–å½“å‰å±å¹•ï¼Œè¿”å› Base64 ç¼–ç çš„å›¾ç‰‡æ•°æ®
        """
        try:
            # æˆªå›¾ï¼ˆè¿”å› PIL Imageï¼‰
            # ä½¿ç”¨æ–°ä¼˜åŒ–çš„æˆªå›¾å‡½æ•°ï¼Œå¯ç”¨ç¼“å­˜å’Œå¿«é€Ÿç¼©æ”¾
            å›¾ç‰‡ = æˆªå–å±å¹•(
                æœ€å¤§å®½åº¦=1024,        # ä¸ºLLMä¼˜åŒ–çš„å°ºå¯¸
                æœ€å¤§é«˜åº¦=1024,
                ä½¿ç”¨ç¼“å­˜=True,         # å¯ç”¨ç¼“å­˜ä»¥é¿å…é¢‘ç¹æˆªå›¾
                å¿«é€Ÿç¼©æ”¾=True          # å¿«é€Ÿç¼©æ”¾ä»¥æé«˜æ€§èƒ½
            )

            if not å›¾ç‰‡:
                return None

            # è½¬æ¢ä¸º Base64
            import io
            ç¼“å†²åŒº = io.BytesIO()
            å›¾ç‰‡.save(ç¼“å†²åŒº, format="PNG")
            base64æ•°æ® = base64.b64encode(ç¼“å†²åŒº.getvalue()).decode("utf-8")

            return base64æ•°æ®

        except Exception as e:
            logger.error(f"æˆªå›¾å¤±è´¥: {e}")
            return None
    
    async def _è°ƒç”¨LLM(self, æˆªå›¾base64: str):
        """
        è°ƒç”¨ LLM æä¾›è€…ï¼Œä¼ å…¥æˆªå›¾å’Œå¯¹è¯å†å²
        """
        try:
            å“åº” = await self.æä¾›è€….å‘é€æ¶ˆæ¯(
                å¯¹è¯å†å²=self.å¯¹è¯å†å²,
                æˆªå›¾base64=æˆªå›¾base64
            )
            return å“åº”
        
        except Exception as e:
            logger.error(f"LLM è°ƒç”¨å¤±è´¥: {e}")
            return None
    
    async def _æ‰§è¡Œå·¥å…·(self, å·¥å…·: å·¥å…·è°ƒç”¨) -> str:
        """
        æ ¹æ®å·¥å…·è°ƒç”¨æ‰§è¡Œå¯¹åº”çš„æ“ä½œ
        """
        å·¥å…·å = å·¥å…·.å·¥å…·åç§°.lower()
        å‚æ•° = å·¥å…·.å‚æ•°
        
        try:
            if å·¥å…·å in ["mouse_move", "left_click", "right_click", "double_click", "scroll"]:
                return æ‰§è¡Œé¼ æ ‡æ“ä½œ(å·¥å…·å, å‚æ•°)
            
            elif å·¥å…·å in ["type", "key", "hotkey"]:
                return æ‰§è¡Œé”®ç›˜æ“ä½œ(å·¥å…·å, å‚æ•°)
            
            else:
                return f"æœªçŸ¥å·¥å…·: {å·¥å…·å}"
        
        except Exception as e:
            return f"æ‰§è¡Œå¤±è´¥: {str(e)}"
    
    async def _å¹¿æ’­(self, ç±»å‹: str, æ¶ˆæ¯: str):
        """
        å‘å‰ç«¯å¹¿æ’­æ—¥å¿—æ¶ˆæ¯
        """
        # åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
        if ç±»å‹ == "error":
            logger.error(æ¶ˆæ¯)
        elif ç±»å‹ == "warning":
            logger.warning(æ¶ˆæ¯)
        else:
            logger.info(æ¶ˆæ¯)
        
        # è°ƒç”¨å¹¿æ’­å‡½æ•°ï¼ˆå¦‚æœæœ‰ï¼‰
        if asyncio.iscoroutinefunction(self.å¹¿æ’­):
            await self.å¹¿æ’­(æ¶ˆæ¯, ç±»å‹)
        else:
            self.å¹¿æ’­(æ¶ˆæ¯, ç±»å‹)
